name: Hourly Counter (GMT-3) via Tailscale

on:
  schedule:
    - cron: "0 12-23 * * *"  # 12h-23h UTC = 9h-20h GMT-3
  workflow_dispatch:

jobs:
  run:
    concurrency:
      group: peoplecounter-hourly
      cancel-in-progress: true
    runs-on: ubuntu-latest
    timeout-minutes: 58
    permissions:
      contents: write

    env:
      REPORT_MODE: gsheets_wide
      RUN_TZ: America/Sao_Paulo
      HEADLESS_MAX_SEC: "3300"
      HEADLESS: "1"
      SAVE_INTERVAL_SEC: "600"
      GSHEETS_CREDENTIALS_JSON: ${{ secrets.GSHEETS_CREDENTIALS_JSON }}
      GSHEETS_SPREADSHEET_ID: ${{ secrets.GSHEETS_SPREADSHEET_ID }}
      GSHEETS_WORKSHEET: ${{ secrets.GSHEETS_WORKSHEET }}
      CAM_LAST_IP: ${{ secrets.CAM_LAST_IP }}
      CAM_CIDR: ${{ secrets.CAM_CIDR }}
      CAM_USER: ${{ secrets.CAM_USER }}
      CAM_PASS: ${{ secrets.CAM_PASS }}
      CAM_PATH: ${{ secrets.CAM_PATH }}
      CAM_PORT: ${{ secrets.CAM_PORT }}
      EXCEL_TENANT_ID: ${{ secrets.EXCEL_TENANT_ID }}
      EXCEL_CLIENT_ID: ${{ secrets.EXCEL_CLIENT_ID }}
      EXCEL_CLIENT_SECRET: ${{ secrets.EXCEL_CLIENT_SECRET }}
      EXCEL_DRIVE_ID: ${{ secrets.EXCEL_DRIVE_ID }}
      EXCEL_ITEM_ID: ${{ secrets.EXCEL_ITEM_ID }}
      EXCEL_WORKSHEET: ${{ secrets.EXCEL_WORKSHEET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Tailscale up
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          args: --accept-routes=true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu \
            torch==2.2.2+cpu torchvision==0.17.2+cpu torchaudio==2.2.2+cpu
          pip install -r requirements.txt

      - name: Quick camera connectivity check
        id: cam_check
        continue-on-error: true
        timeout-minutes: 3
        shell: python
        run: |
          import os, socket, time
          
          def tcp_ok(ip: str, port: int, timeout: int = 5) -> bool:
            try:
              with socket.create_connection((ip, port), timeout=timeout):
                return True
            except Exception:
              return False
          
          last_ip = os.getenv('CAM_LAST_IP')
          port = int(os.getenv('CAM_PORT', '554'))
          
          for i in range(3):
            if tcp_ok(last_ip, port, timeout=5):
              print(f"âœ“ Camera reachable at {last_ip}:{port}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write("reachable=true\n")
              exit(0)
            if i < 2:
              time.sleep(60)
          
          print(f"âœ— Camera NOT reachable at {last_ip}:{port}")
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write("reachable=false\n")

      - name: Calculate execution window
        id: timing
        shell: python
        run: |
          import os
          
          cam_ok = '${{ steps.cam_check.outputs.reachable }}' == 'true'
          
          if not cam_ok:
            print("âš  Camera not reachable - SKIPPING this cycle")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write("skip=true\n")
          else:
            print("âœ“ Camera OK - starting counter")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write("skip=false\n")

      - name: Run counter headless
        if: steps.timing.outputs.skip != 'true'
        timeout-minutes: 57
        env:
          PYTHONUNBUFFERED: "1"
          RTSP_URL: "rtsp://${{ secrets.CAM_USER }}:${{ secrets.CAM_PASS }}@${{ secrets.CAM_LAST_IP }}:${{ secrets.CAM_PORT }}/${{ secrets.CAM_PATH }}"
        run: |
          echo "ðŸš€ Iniciando contador headless..."
          python run_counter_headless.py 2>&1 | tee counter_output.log
          echo "âœ“ Contador finalizado"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: counter-logs-${{ github.run_number }}
          path: |
            counter_output.log
            *.log
          retention-days: 7

      - name: Commit CSV
        if: env.REPORT_MODE == 'csv'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add movimento_entradas.csv || true
          git commit -m "update csv" || true
          git push || true