name: Hourly Counter (GMT-3) via Tailscale

on:
  schedule:
    - cron: "0 12-23 * * *"  # 12h-23h UTC = 9h-20h GMT-3
  workflow_dispatch:

jobs:
  run:
    concurrency:
      group: peoplecounter-hourly
      cancel-in-progress: true
    runs-on: ubuntu-latest
    timeout-minutes: 58
    permissions:
      contents: write

    env:
      REPORT_MODE: gsheets
      RUN_TZ: America/Sao_Paulo
      HEADLESS_MAX_SEC: "3300"
      HEADLESS: "1"
      SAVE_INTERVAL_SEC: "600"
      GSHEETS_CREDENTIALS_JSON: ${{ secrets.GSHEETS_CREDENTIALS_JSON }}
      GSHEETS_SPREADSHEET_ID: ${{ secrets.GSHEETS_SPREADSHEET_ID }}
      GSHEETS_WORKSHEET: ${{ secrets.GSHEETS_WORKSHEET }}
      CAM_LAST_IP: ${{ secrets.CAM_LAST_IP }}
      CAM_CIDR: ${{ secrets.CAM_CIDR }}
      CAM_USER: ${{ secrets.CAM_USER }}
      CAM_PASS: ${{ secrets.CAM_PASS }}
      CAM_PATH: ${{ secrets.CAM_PATH }}
      CAM_PORT: ${{ secrets.CAM_PORT }}
      EXCEL_TENANT_ID: ${{ secrets.EXCEL_TENANT_ID }}
      EXCEL_CLIENT_ID: ${{ secrets.EXCEL_CLIENT_ID }}
      EXCEL_CLIENT_SECRET: ${{ secrets.EXCEL_CLIENT_SECRET }}
      EXCEL_DRIVE_ID: ${{ secrets.EXCEL_DRIVE_ID }}
      EXCEL_ITEM_ID: ${{ secrets.EXCEL_ITEM_ID }}
      EXCEL_WORKSHEET: ${{ secrets.EXCEL_WORKSHEET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Tailscale up
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          args: --accept-routes=true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu \
            torch==2.2.2+cpu torchvision==0.17.2+cpu torchaudio==2.2.2+cpu
          pip install -r requirements.txt

      - name: Resolve camera IP
        id: cam_resolve
        continue-on-error: true
        timeout-minutes: 3
        shell: python
        run: |
          import sys
          sys.path.insert(0, '.')
          from camera_resolver import resolve_rtsp
          import os
          
          print("ðŸ” Resolvendo IP da cÃ¢mera...")
          
          url = resolve_rtsp(
              last_ip=os.getenv('CAM_LAST_IP'),
              cidr=os.getenv('CAM_CIDR'),
              user=os.getenv('CAM_USER'),
              password=os.getenv('CAM_PASS'),
              path=os.getenv('CAM_PATH'),
              port=int(os.getenv('CAM_PORT', '554')),
              use_cache=True
          )
          
          if url:
              # Esconde credenciais no log
              safe_url = url.split('@')[1] if '@' in url else url
              print(f"âœ“ CÃ¢mera encontrada: {safe_url}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"rtsp_url={url}\n")
                  f.write("resolved=true\n")
          else:
              print("âœ— CÃ¢mera nÃ£o encontrada na rede")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("resolved=false\n")

      - name: Check camera resolution
        id: timing
        shell: python
        run: |
          import os
          
          cam_ok = '${{ steps.cam_resolve.outputs.resolved }}' == 'true'
          
          if not cam_ok:
            print("âš  Camera not resolved - SKIPPING this cycle")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write("skip=true\n")
          else:
            print("âœ“ Camera resolved - starting counter")
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write("skip=false\n")

      - name: Run counter headless
        if: steps.timing.outputs.skip != 'true'
        timeout-minutes: 57
        env:
          PYTHONUNBUFFERED: "1"
          RTSP_URL: ${{ steps.cam_resolve.outputs.rtsp_url }}
        run: |
          echo "ðŸš€ Iniciando contador headless..."
          python run_counter_headless.py 2>&1 | tee counter_output.log
          echo "âœ“ Contador finalizado"
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: counter-logs-${{ github.run_number }}
          path: |
            counter_output.log
            *.log
          retention-days: 7

      - name: Commit CSV
        if: env.REPORT_MODE == 'csv'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add movimento_entradas.csv || true
          git commit -m "update csv" || true
          git push || true